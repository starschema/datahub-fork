# Executor Action Configuration for UI-based Ingestion
# This action listens for ingestion execution requests from the DataHub UI
# and spawns ingestion processes to execute them

name: "ingestion_executor"

source:
  type: "kafka"
  config:
    connection:
      bootstrap: "broker:29092"
      schema_registry_url: "http://schema-registry:8081"
    topic_routes:
      mcl: "MetadataChangeLog_Versioned_v1"
      pe: "PlatformEvent_v1"

filter:
  event_type: "MetadataChangeLogEvent_v1"
  event:
    entityType: "dataHubExecutionRequest"
    changeType: "UPSERT"
    aspectName:
      - "dataHubExecutionRequestInput"
      - "dataHubExecutionRequestSignal"
    aspect:
      value:
        executorId: "default"

action:
  type: "executor"
  config:
    executor_id: "default"
    # System authentication - passed to ingestion processes
    system_id: "__datahub_system"
    # The secret is automatically picked up from DATAHUB_SYSTEM_CLIENT_SECRET env var
    task_configs:
      - name: "RUN_INGEST"
        type: "acryl.executor.execution.sub_process_ingestion_task.SubProcessIngestionTask"
        configs: {}
      - name: "TEST_CONNECTION"
        type: "acryl.executor.execution.sub_process_test_connection_task.SubProcessTestConnectionTask"
        configs: {}

datahub:
  server: "http://datahub-gms:8080"
  # Token-based authentication for ingestion processes
  # The executor will pass this token to spawned ingestion subprocesses
  token: "${DATAHUB_SYSTEM_CLIENT_SECRET}"
